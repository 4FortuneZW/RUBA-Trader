name: Automatic Push to Remote

on:
  # Trigger on Discord bot logs update
  push:
    branches:
      - main
    paths:
      - 'discord-bot/**'
      - 'logs/**'
      - '.env.local'
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      commit_message:
        description: 'Commit message for push'
        required: true
        default: 'Auto commit from GitHub Actions'
        type: string
      reason:
        description: 'Reason for manual push'
        required: false
        default: 'Manual push request'
        type: string

jobs:
  auto-push:
    name: Auto Push Changes
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Check for changes
        id: check_changes
        run: |
          # Check if there are uncommitted changes
          if [ -n "$(git status --porcelain)" ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected:"
            git status --short
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes to push"
          fi

      - name: Stage and commit changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "Staging and committing changes..."
          
          # Get commit message based on trigger
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            MESSAGE="${{ github.event.inputs.commit_message }}"
          else
            MESSAGE="Auto commit: ${{ github.event.head_commit.message }}"
          fi
          
          # Add all changes
          git add .
          
          # Commit changes
          git commit -m "$MESSAGE" -m "Triggered by: ${{ github.event_name }}" -m "Workflow: ${{ github.workflow }}" -m "Run #${{ github.run_number }}"
          
          echo "Commit created: $(git rev-parse --short HEAD)"

      - name: Push to remote
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "Pushing changes to remote..."
          git push origin main
          
          echo "‚úÖ Changes pushed successfully"
          echo "Branch: main"
          echo "Commit: $(git rev-parse --short HEAD)"
          echo "Timestamp: $(date)"

      - name: Notify on success
        if: success() && steps.check_changes.outputs.has_changes == 'true'
        run: |
          echo "üéâ Auto push completed successfully"
          echo ""
          echo "Details:"
          echo "- Repository: ${{ github.repository }}"
          echo "- Branch: main"
          echo "- Commit: $(git rev-parse --short HEAD)"
          echo "- Triggered by: ${{ github.event_name }}"
          echo "- Timestamp: $(date)"

      - name: No changes notification
        if: success() && steps.check_changes.outputs.has_changes == 'false'
        run: |
          echo "‚ÑπÔ∏è No changes to push. Repository is up to date."

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Auto push failed"
          echo "Please check the logs for details"
          exit 1

  sync-and-push:
    name: Sync Local Changes and Push
    runs-on: ubuntu-latest
    needs: auto-push
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Sync with remote
        run: |
          echo "Syncing with remote repository..."
          git fetch origin main
          
          # Check if we're behind remote
          BEHIND=$(git rev-list --count HEAD..origin/main)
          
          if [ "$BEHIND" -gt 0 ]; then
            echo "Repository is $BEHIND commits behind remote"
            echo "Pulling latest changes..."
            git pull origin main --rebase
            
            echo "Pushing merged changes..."
            git push origin main
          else
            echo "Repository is up to date with remote"
          fi

      - name: Sync summary
        run: |
          echo "üìä Sync Summary:"
          echo "- Current branch: $(git branch --show-current)"
          echo "- Latest commit: $(git rev-parse --short HEAD)"
          echo "- Remote status: $(git status -sb | head -1)"
          echo "- Timestamp: $(date)"
